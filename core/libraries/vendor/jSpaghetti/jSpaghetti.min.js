(function(){const LAST_COMMAND_TERMINATED="lastCommandTerminated",SEQUENCE_RELEASED="sequenceReleased",PAGE_IS_ABOUT_TO_RELOAD="beforeunload",SEQUENCE_TERMINATED="terminated",SEQUENCE_ERROR="error",SEQUENCE_RESET="reset",STORAGE_NAME=(e,t)=>`"jSpaghetti: ${e}:${t}`,EXIT_COMMAND="exit",GOTOIF_COMMAND="jumpif",WAIT_COMMAND="wait",WAIT_FOR_PAGE_TO_RELOAD="page-reload",INTERNAL_OBJECT_COMMANDS_LIST=[WAIT_COMMAND,GOTOIF_COMMAND,EXIT_COMMAND],DEFAULT_DELAY=10;function Route(e,t){this.instruction=e,this.command=t}function State(e,t,s,n){this.route=e,this.shared=t,this.lastProcedureRoute=s,this.callLastProcedure=n}function getFirstAttribName(e){return Object.keys(e)[0]}function getInstructionByRoute(e,t){var s=getFirstAttribName(e[t.instruction]);return{label:s,commands:e[t.instruction][s]}}function getCommandByRoute(e,t){return getInstructionByRoute(e,t).commands[t.command]}function getNextRoute(e,t){var s=getInstructionByRoute(e,t).commands,n=new Route(t.instruction,t.command);return t.command<s.length-1?n.command+=1:t.instruction<e.length-1?(n.instruction+=1,n.command=0):n=null,n}function getInstructionPosByLabel(e,t){for(var s=0;s<t.length;s++)if(t[s].hasOwnProperty(e))return s;return!1}function checkInstructionsSyntax(e,t){if(e.length>0){for(var s=0;s<e.length;s++){var n=getFirstAttribName(e[s]);"[object Array]"!=Object.prototype.toString.call(e[s][n])&&(e[s][n]=[e[s][n]]);for(var o=0;o<e[s][n].length;o++)if("object"==typeof e[s][n][o]){var a=getFirstAttribName(e[s][n][o]);if(-1==INTERNAL_OBJECT_COMMANDS_LIST.indexOf(a))return'Internal command "'+a+'" is undefined';var r=e[s][n][o][a];if(a==EXIT_COMMAND||a==WAIT_COMMAND){if("object"==typeof r)return'Label "'+getFirstAttribName(r)+'" is undefined'}else if(a==GOTOIF_COMMAND){if("[object Array]"!=Object.prototype.toString.call(r))return'Internal command "'+a+'" must receive an array';if(r.length<2)return'Internal command "'+a+'" must receive an array that must have at least 2 positions';for(var i=1;i<r.length;i++){var u=r[i];if(!1===getInstructionPosByLabel(u,e)&&u!=EXIT_COMMAND)return'Instruction label "'+u+'" is undefined'}}}else{var c=e[s][n][o];if(!t.hasOwnProperty(c)&&c!=EXIT_COMMAND)return'Procedure "'+c+'" is undefined'}}return!0}return"There are no instructions to be executed"}function throwErrorNotification(e,t,s,n){console.error("jSpaghetti error:",e,t),s&&s.dispatchEvent(n)}function showDebugMessage(e,t){console.log("jSpaghetti debug:",e,t)}function evaluateExpression(expression,shared){const STORAGETOKEN=/\*|SHARED/g;expression=String(expression).replace(STORAGETOKEN,"shared");var result=eval(expression);return result}function getSharedFunctions(e,t){return{next:function(s){const n=jSpaghetti.modules[e].sequences[t];n.blocked=!0;const o=()=>{n.blocked=!1,jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Next called ("+e+":"+t+"): ",s),n.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,n))};if(n.state.callLastProcedure=!1,n.state.shared.$=s,n.released)o();else{const e=setInterval((()=>{n.released&&(clearInterval(e),o())}),5*DEFAULT_DELAY)}},raise:function(s){const n=jSpaghetti.modules[e].sequences[t];n.blocked=!0;const o=()=>{let n=jSpaghetti.modules[e].sequences[t];n.blocked=!1,jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Error raised ("+e+":"+t+"): ",s);let o=s+" ("+e+":"+t+")";n.events.dispatchEvent(getEvent(SEQUENCE_ERROR,o))};if(n.released)o();else{const e=setInterval((()=>{n.released&&(clearInterval(e),o())}),5*DEFAULT_DELAY)}},getObjectSnapshot:getObjectSnapshot}}function dispatchExitCommand(e,t){jSpaghetti.modules[e].sequences[t].state.route=null,jSpaghetti.modules[e].config.debugMode&&showDebugMessage("Exit command dispatched ("+e+":"+t+")"," ")}function getObjectSnapshot(e){return"object"==typeof e&&JSON.parse(JSON.stringify(e))}function getEvent(e,t){return new CustomEvent(e,{detail:t})}function startStateSaver(){window.addEventListener(PAGE_IS_ABOUT_TO_RELOAD,(function(e){for(var t in jSpaghetti.state.ready=!1,jSpaghetti.modules)for(var s in jSpaghetti.modules[t].sequences){new jSpaghetti.Storage(STORAGE_NAME(t,s)).set(jSpaghetti.modules[t].sequences[s].state,(function(){}))}}))}function runAssyncronously(e){setTimeout((function(){e()}),0)}var jSpaghetti={state:{ready:!0,running:!1},version:"0.1.6",modules:{},module:function(e){var t=jSpaghetti.modules[e],s={name:e,config:{debugMode:!1,developerMode:!1},sequences:{},procedures:{},procedure:function(e,s){t.procedures[e]=s},sequence:function(s){var n=t.sequences[s],o=new State(new Route(0,0),{},null,!1),a={name:s,hooks:getSharedFunctions(e,s),module:t,events:document.createDocumentFragment(),state:o,released:!0,blocked:!1,instructions:[],run:function(o){setTimeout((function(){if(jSpaghetti.state.ready){jSpaghetti.state.running||(jSpaghetti.state.running=!0,startStateSaver());var a=checkInstructionsSyntax(n.instructions,t.procedures),r=function(o){if(o&&(n.state=o),n.state.route&&!0===a){n.state.callLastProcedure&&(n.state.callLastProcedure=!1,n.state.route=n.state.lastProcedureRoute);var r=getCommandByRoute(n.instructions,n.state.route),i=n.state.route.command,u=getInstructionByRoute(n.instructions,n.state.route).label,c=getNextRoute(n.instructions,n.state.route);if("object"==typeof r)switch(Object.keys(r)[0]){case WAIT_COMMAND:if(r[WAIT_COMMAND]==WAIT_FOR_PAGE_TO_RELOAD)n.state.route=c,t.config.debugMode&&showDebugMessage("Waiting for page to reload ("+e+":"+s+":"+u+":"+i+")"," ");else{var d=evaluateExpression(r[WAIT_COMMAND],n.state.shared);t.config.debugMode&&showDebugMessage("Waiting "+d+" ms ("+e+":"+s+":"+u+":"+i+")"," ");var g=0,E=setInterval((function(){g++,(!n.state.route||g>=d/DEFAULT_DELAY)&&(clearInterval(E),n.state.route?n.state.route=c:t.config.debugMode&&showDebugMessage("Wait process was abruptly interrupted ("+e+":"+s+")"," "),n.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,n)))}),DEFAULT_DELAY)}break;case GOTOIF_COMMAND:if(evaluateExpression(r[GOTOIF_COMMAND][0],n.state.shared)){t.config.debugMode&&showDebugMessage("Gotoif returned true ("+e+":"+s+":"+u+":"+i+")"," ");var l=r[GOTOIF_COMMAND][1];n.state.route.command=0,n.state.route.instruction=getInstructionPosByLabel(r[GOTOIF_COMMAND][1],n.instructions)}else if(t.config.debugMode&&showDebugMessage("Gotoif returned false ("+e+":"+s+":"+u+":"+i+")"," "),r[GOTOIF_COMMAND].length>2){l=r[GOTOIF_COMMAND][2];n.state.route.command=0,n.state.route.instruction=getInstructionPosByLabel(r[GOTOIF_COMMAND][2],n.instructions)}else n.state.route=c;l&&t.config.debugMode&&showDebugMessage('Flow redirected to "'+l+'" ('+e+":"+s+")"," "),n.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,n));break;case EXIT_COMMAND:evaluateExpression(r[EXIT_COMMAND],n.state.shared)?(t.config.debugMode&&showDebugMessage("Exit returned true ("+e+":"+s+":"+u+":"+i+")"," "),dispatchExitCommand(e,s)):(t.config.debugMode&&showDebugMessage("Exit returned false ("+e+":"+s+":"+u+":"+i+")"," "),n.state.route=c),n.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,n))}else n.state.lastProcedureRoute=new Route(n.state.route.instruction,n.state.route.command),n.state.route=c,t.config.debugMode&&showDebugMessage("Running command",'"'+e+":"+s+":"+u+":"+i+":"+r+'"'),n.released=!1,n.state.callLastProcedure=!0,runAssyncronously((function(){try{const e=t.procedures[r](n.state.shared,n.hooks);void 0!==e?(n.state.callLastProcedure=!1,n.state.shared.$=e,n.events.dispatchEvent(getEvent(LAST_COMMAND_TERMINATED,n))):n.events.dispatchEvent(getEvent(SEQUENCE_RELEASED,n))}catch(t){let o=t+" ("+e+":"+s+":"+u+":"+i+":"+r+")";throwErrorNotification(o," ",n.events,getEvent(SEQUENCE_ERROR,o))}}))}else if(!0!==a){let t=a+" ("+e+":"+s+")";throwErrorNotification(t," ",n.events,getEvent(SEQUENCE_ERROR,t))}else null==n.state.route&&(t.config.debugMode&&showDebugMessage("Sequence is terminated ("+e+":"+s+")"," "),n.events.dispatchEvent(getEvent(SEQUENCE_TERMINATED,n)))};if(o)t.config.developerMode&&showDebugMessage("Data recovered from the last state ("+e+":"+s+"): ",getObjectSnapshot(n.state)),r(o);else new jSpaghetti.Storage(STORAGE_NAME(e,s)).get((function(o){o?(t.config.developerMode&&showDebugMessage("Data recovered from the local storage ("+e+":"+s+"): ",getObjectSnapshot(o)),o.shared&&(o.shared={...n.state.shared,...o.shared}),r(o)):(t.config.developerMode&&showDebugMessage("Data recovered from the initial state ("+e+":"+s+"): ",getObjectSnapshot(n.state)),r(n.state))}))}else t.config.developerMode&&showDebugMessage("jSpaghetti is not ready: Probably the page is about to be reloaded ("+e+":"+s+")"," ")}),DEFAULT_DELAY)},reset:function(o){n.state.route=null,setTimeout((function(){var a=new Route(0,0);n.state=new State(a,{$:void 0},null,!1),new jSpaghetti.Storage(STORAGE_NAME(e,s)).reset((function(){o&&o(n)})),t.config.debugMode&&showDebugMessage("Sequence is reset ("+e+":"+s+")"," "),n.events.dispatchEvent(getEvent(SEQUENCE_RESET,n))}),5*DEFAULT_DELAY)}};return a.events.addEventListener(LAST_COMMAND_TERMINATED,(o=>{o.stopPropagation(),t.config.developerMode&&showDebugMessage("Last command terminated event dispatched ("+e+":"+s+"): ",getObjectSnapshot(n.state)),n.blocked?t.config.developerMode&&showDebugMessage("The sequence is currently blocked. Running next state was skipped ("+e+":"+s+"): ",getObjectSnapshot(n.state)):t.sequences[s].run(n.state),t.sequences[s].events.dispatchEvent(getEvent(SEQUENCE_RELEASED,t.sequences[s]))})),a.events.addEventListener(SEQUENCE_RELEASED,(o=>{o.stopPropagation(),t.config.developerMode&&showDebugMessage("Procedure released event dispatched ("+e+":"+s+"): ",getObjectSnapshot(n.state)),t.sequences[s].released=!0})),a.events.addEventListener(SEQUENCE_TERMINATED,(o=>{o.stopPropagation(),t.config.developerMode&&showDebugMessage("Sequence terminated event dispatched ("+e+":"+s+"): ",getObjectSnapshot(n.state)),t.sequences[s].released=!0})),null==n&&(t.sequences[s]=a,n=t.sequences[s]),t.sequences[s]}};return null==t&&(jSpaghetti.modules[e]=s,t=jSpaghetti.modules[e]),t},Storage:function(e){this.get=function(t){t&&runAssyncronously((function(){t(JSON.parse(sessionStorage.getItem(e)))}))},this.set=function(t,s){s&&runAssyncronously(s),sessionStorage.setItem(e,JSON.stringify(t))},this.reset=function(t){t&&runAssyncronously(t),sessionStorage.removeItem(e)}}};$jSpaghetti=jSpaghetti})();